<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lettore GLS - Smart Scan</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        :root {
            --primary: #0b2d51; 
            --accent: #fdb913;
            --bg: #f0f2f5;
            --text: #333;
            --text-light: #666;
            --white: #ffffff;
            --success: #28a745;
            --error: #dc3545;
            --border: #dee2e6;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --card-radius: 12px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- HEADER & CONTROLLI --- */
        .top-section {
            flex-shrink: 0; background-color: var(--bg); z-index: 100;
            padding: 10px 15px 0 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }

        header { 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding: 0 5px;
        }
        
        header h1 { 
            color: var(--primary); margin: 0; font-size: 1.3rem; 
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: 800;
        }

        .control-card {
            background: var(--white); border-radius: var(--card-radius); 
            box-shadow: var(--shadow); border-top: 4px solid var(--primary);
            padding: 15px; margin-bottom: 10px;
        }

        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: start; }
        
        /* PULSANTE MICROFONO */
        .btn-mic {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: bold; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            width: 100%; height: 100%; min-height: 80px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;
        }
        .btn-mic.active { 
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            box-shadow: 0 0 15px rgba(40, 167, 69, 0.4); transform: translateY(-1px);
        }
        .btn-mic span { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-mic .icon { font-size: 1.5rem; }

        .visualizer-container {
            height: 6px; background: #e9ecef; border-radius: 10px; 
            margin-top: 8px; overflow: hidden; position: relative; width: 100%;
        }
        .visualizer-bar {
            height: 100%; width: 0%; 
            background: linear-gradient(90deg, var(--accent), var(--success));
            transition: width 0.05s linear;
        }
        .visualizer-threshold { position: absolute; top: 0; bottom: 0; width: 2px; background: var(--error); z-index: 5; }

        /* DROP ZONE MODIFICATA */
        .drop-zone {
            border: 2px dashed #cbd5e0; background-color: #f8f9fa; 
            border-radius: 8px; padding: 10px; text-align: center; 
            height: 100%; min-height: 80px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; transition: all 0.2s;
        }
        .drop-zone.dragover { border-color: var(--primary); background-color: #e8f0fe; }
        .drop-zone p { margin: 0 0 8px 0; font-weight: 700; color: var(--primary); font-size: 0.85rem; text-transform: uppercase; }
        
        /* pulsanti dentro la dropzone */
        .drop-actions { display: flex; gap: 8px; width: 100%; }
        
        .btn-drop-action {
            flex: 1; padding: 8px 5px; border: 1px solid #ced4da; border-radius: 6px;
            font-size: 0.75rem; font-weight: 600; cursor: pointer; text-decoration: none;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            transition: all 0.2s; color: var(--text); background: white;
        }
        .btn-drop-action:hover { background-color: #e2e6ea; border-color: #adb5bd; }
        
        .btn-server {
            background-color: #e3f2fd; color: #0d47a1; border-color: #90caf9;
        }
        .btn-server:hover { background-color: #bbdefb; border-color: #64b5f6; }

        .input-group label { display: block; margin-bottom: 5px; font-weight: 700; font-size: 0.75rem; color: #666; text-transform: uppercase; }
        
        .styled-select, .search-box, .manual-input {
            width: 100%; padding: 10px 12px; 
            border: 1px solid #ced4da; border-radius: 6px;
            font-size: 0.95rem; background-color: #fff; color: var(--text);
            appearance: none; -webkit-appearance: none;
        }
        .styled-select {
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right .7em top 50%; background-size: .65em auto;
        }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--primary); height: 4px; margin-top: 5px; }

        .settings-grid {
            display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; 
            margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee;
        }

        .stats-bar {
            display: flex; justify-content: space-between; font-size: 0.8rem; 
            color: #888; padding: 5px 5px; border-top: 1px solid #eee; margin-top: 10px;
        }
        .stats-highlight { color: var(--primary); font-weight: 700; }

        .btn-manual {
            background-color: var(--accent); color: var(--primary); border: none;
            padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 5px;
        }
        .btn-manual:hover { background-color: #ffc107; transform: translateY(-1px); }

        /* --- LISTA --- */
        .list-container {
            flex-grow: 1; overflow-y: auto; position: relative;
            padding: 15px; scroll-behavior: smooth;
            background: linear-gradient(180deg, var(--bg) 0%, #e2e6ea 100%);
        }
        .barcode-list { 
            display: flex; flex-direction: column; gap: 15px; 
            max-width: 800px; margin: 0 auto;
            padding-top: 40vh; padding-bottom: 40vh; 
        }

        .barcode-card {
            background: var(--white); border-radius: 12px; padding: 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 6px solid #ccc; 
            display: grid; grid-template-columns: 70px 1fr; overflow: hidden; cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); opacity: 0.6; transform: scale(0.97);
        }
        .zone-box {
            background: #f8f9fa; color: var(--primary); 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; border-right: 1px solid #eee;
        }
        .zone-box h2 { font-size: 1.8rem; font-weight: 800; margin: 0; line-height: 1; }
        .zone-box span { font-size: 0.6rem; color: #aaa; font-weight: 700; text-transform: uppercase; margin-top: 2px; }
        .card-content { padding: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        .human-readable {
            font-family: 'Courier New', monospace; font-size: 1.1rem; font-weight: 800; 
            letter-spacing: 1px; color: var(--text); margin-top: 5px;
        }
        .details { font-size: 0.85rem; color: #888; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        canvas, svg { max-width: 100%; height: 60px; transition: height 0.3s; }

        .barcode-card.active-focus {
            opacity: 1; transform: scale(1.03); 
            box-shadow: 0 10px 30px rgba(11, 45, 81, 0.2); 
            border-top: 4px solid var(--accent); border-bottom: 4px solid var(--accent); border-right: 4px solid var(--accent);
            background-color: #fff; z-index: 50;
        }
        .barcode-card.active-focus svg { height: 120px; }
        .barcode-card.active-focus .human-readable { font-size: 1.5rem; color: var(--primary); }
        .barcode-card.active-focus .zone-box { background: var(--primary); color: var(--accent); }
        .barcode-card.active-focus .zone-box span { color: rgba(255,255,255,0.7); }
        .barcode-card.scanned {
            background-color: #e6f4ea; opacity: 0.4; transform: scale(0.95);
            filter: grayscale(100%); border-left-color: #ccc !important;
        }

        .border-A { border-left-color: #dc3545; } .border-B { border-left-color: #0d6efd; }
        .border-C { border-left-color: #ffc107; } .border-D { border-left-color: #6f42c1; }
        .border-E { border-left-color: #198754; } .border-F { border-left-color: #fd7e14; }
        .border-G { border-left-color: #0dcaf0; }

        .empty-state { text-align: center; padding: 50px 20px; color: #aaa; font-style: italic; margin-top: -20vh; }
        .status-led {
            width: 10px; height: 10px; border-radius: 50%; background: #ddd; 
            transition: background 0.1s; border: 2px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.1);
        }
        .status-led.flash { background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* --- MODAL MANUALE --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-card {
            background: white; width: 90%; max-width: 400px;
            border-radius: 16px; padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border-top: 5px solid var(--accent);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-card h3 { margin: 0 0 15px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-grid-2 { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px; }
        .modal-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        
        .btn-modal-close { background: #eee; color: #555; }
        .btn-modal-add { background: var(--primary); color: white; }
        .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
        .modal-actions button { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .preview-box {
            background: #f8f9fa; border: 1px dashed #ccc; padding: 10px;
            text-align: center; border-radius: 8px; min-height: 80px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .preview-text { font-family: monospace; font-weight: bold; margin-top: 5px; color: #555; }
    </style>
</head>
<body>

    <div id="manualModal" class="modal-overlay">
        <div class="modal-card">
            <h3>Generazione Manuale</h3>
            
            <div class="modal-grid-2">
                <div>
                    <label>Sede Mitt. (2-4)</label>
                    <input id="manSede" class="manual-input" maxlength="4" placeholder="AB" oninput="this.value = this.value.toUpperCase(); updateManualPreview()">
                </div>
                <div>
                    <label>N. Sped (Max 9)</label>
                    <input id="manSped" class="manual-input" maxlength="9" placeholder="123456789" type="tel" oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateManualPreview()">
                </div>
            </div>

            <div class="modal-grid-3">
                <div>
                    <label>Collo</label>
                    <input id="manCollo" class="manual-input" type="number" placeholder="1" oninput="updateManualPreview()">
                </div>
                <div>
                    <label>Tipo (1)</label>
                    <input id="manTipo" class="manual-input" type="tel" maxlength="1" placeholder="0" oninput="this.value = this.value.replace(/[^0-9]/g, ''); updateManualPreview()">
                </div>
                <div>
                    <label>Dest (2-4)</label>
                    <input id="manDest" class="manual-input" maxlength="4" placeholder="V3" oninput="this.value = this.value.toUpperCase(); updateManualPreview()">
                </div>
            </div>

            <div class="preview-box">
                <svg id="manualBarcode"></svg>
                <div id="manualText" class="preview-text">Anteprima...</div>
            </div>

            <div class="modal-actions">
                <button class="btn-modal-close" onclick="closeModal()">Annulla</button>
                <button class="btn-modal-add" onclick="addManualItem()">Aggiungi alla Lista</button>
            </div>
        </div>
    </div>

    <div class="top-section">
        <header>
            <h1>Lettore GLS</h1>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button class="btn-manual" onclick="openModal()">+ Manuale</button>
                <div class="status-led" id="triggerLed"></div>
            </div>
        </header>

        <div class="control-card">
            <div class="controls-grid">
                <div>
                    <button class="btn-mic" id="btnMic" onclick="toggleAudio()">
                        <div class="icon">üéôÔ∏è</div>
                        <span id="micText">Attiva Ascolto</span>
                        <div class="visualizer-container">
                            <div class="visualizer-bar" id="audioBar"></div>
                            <div class="visualizer-threshold" id="threshLine" style="left: 85%;"></div>
                        </div>
                    </button>
                </div>
                
                <div class="drop-zone" id="dropZone">
                    <p>üìÇ Area Caricamento</p>
                    <div class="drop-actions">
                        <input type="file" id="fileInput" accept=".txt,.csv" style="display:none">
                        <button class="btn-drop-action" onclick="document.getElementById('fileInput').click()">
                            üìÅ Sfoglia PC
                        </button>
                        <a class="btn-drop-action btn-server" href="search-ms:displayname=Risultati%20ricerca%20in%20%5C%5C10.58.125.2%5Cpc&crumb=System.Generic.String%3Anatana&crumb=location:%5C%5C10.58.125.2%5Cpc" target="_blank">
                            üîç Apri Server
                        </a>
                    </div>
                    <span style="font-size:0.7em; color:#999; margin-top:5px;">o trascina il file qui</span>
                </div>
            </div>

            <div class="settings-grid">
                <div class="input-group">
                    <label>Filtro Sequenza</label>
                    <select id="filterLogic" class="styled-select" onchange="reprocessFile()">
                        <option value="NS" selected>‚ú± N S (Richiesto)</option>
                        <option value="SN">‚ú± S N (Standard)</option>
                        <option value="NN">‚ú± N N</option>
                        <option value="SS">‚ú± S S</option>
                        <option value="ALL">Mostra Tutto</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <div style="display:flex; justify-content:space-between;">
                        <label>Calibrazione Audio</label>
                        <span id="freqVal" style="font-size:0.7em; color:var(--primary);">3000 Hz</span>
                    </div>
                    <input type="range" id="freqInput" min="2000" max="4000" value="3000" oninput="updateFreq(this.value)" title="Frequenza">
                    <input type="range" id="threshInput" min="50" max="98" value="85" oninput="updateThreshold(this.value)" title="Soglia" style="margin-top:8px; accent-color:var(--error);">
                </div>
            </div>
            
            <div class="stats-bar">
                <span id="statsTotal">In attesa file...</span>
                <span id="statsDone" class="stats-highlight">0 Fatti</span>
            </div>
        </div>

        <input type="text" class="search-box" id="searchInput" placeholder="üîç Cerca spedizione o zona..." onkeyup="filterData()">
    </div>

    <div class="list-container" id="scrollContainer">
        <div id="listResult" class="barcode-list"></div>
        <div id="emptyState" class="empty-state">Nessun dato caricato.</div>
    </div>

<script>
    let allData = [];
    let scannedCount = 0;
    let currentFileContent = ""; 

    // --- MANUALE ---
    function openModal() {
        document.getElementById('manualModal').style.display = 'flex';
        document.getElementById('manSede').focus();
        updateManualPreview();
    }
    function closeModal() { document.getElementById('manualModal').style.display = 'none'; }
    
    function updateManualPreview() {
        const sede = document.getElementById('manSede').value || "XX";
        let sped = (document.getElementById('manSped').value || "000000000");
        
        if (sede.toUpperCase() === 'WW' && sped.length < 9) {
            sped = sped.padStart(9, '0');
        } else {
            sped = sped.padEnd(9, '0');
        }

        let colloRaw = document.getElementById('manCollo').value || "1";
        const collo = colloRaw.padStart(2, '0'); 
        const tipo = document.getElementById('manTipo').value || "0";
        const dest = document.getElementById('manDest').value || "DEST";

        const code = `${sede}${sped}${collo}${tipo}${dest}`;
        const human = `${sede} ${sped} ${collo} ${tipo} ${dest}`;
        
        document.getElementById('manualText').innerText = human;
        try {
            JsBarcode("#manualBarcode", code, { format: "CODE128", width: 1.5, height: 50, displayValue: false, margin: 0 });
        } catch(e) {}
    }

    function addManualItem() {
        const sede = document.getElementById('manSede').value.toUpperCase();
        let sped = document.getElementById('manSped').value;
        let collo = (document.getElementById('manCollo').value || "1").padStart(2,'0');
        const tipo = document.getElementById('manTipo').value || "0";
        const dest = document.getElementById('manDest').value.toUpperCase() || "???";

        if (!sede || !sped) { alert("Sede e Spedizione obbligatori"); return; }

        if (sede === 'WW' && sped.length < 9) {
            sped = sped.padStart(9, '0');
        } else {
            sped = sped.padStart(9, '0');
        }

        const barcodeData = `${sede}${sped}${collo}${tipo}${dest}`;
        const humanText = `${sede} ${sped} ${collo} ${tipo} ${dest}`;
        const zoneChar = dest.charAt(0).toUpperCase() || "A";

        const newItem = {
            id: Date.now(), 
            zona: dest,
            barcodeData: barcodeData,
            humanText: humanText,
            details: "GENERATO MANUALMENTE",
            colorClass: `border-${zoneChar}`,
            fullSearch: (humanText + " " + dest).toLowerCase()
        };

        allData.unshift(newItem); 
        renderList(allData);
        updateFocus();
        closeModal();
        
        document.getElementById('manSped').value = "";
        document.getElementById('manCollo').value = "";
    }

    // --- AUDIO SYSTEM ---
    let audioContext, analyser, microphone, filter1, filter2, gainNode;
    let isListening = false;
    let volumeThreshold = 0.85; 
    let targetFreq = 3000;
    let cooldown = false;

    async function toggleAudio() {
        if (isListening) { location.reload(); return; }
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            
            filter1 = audioContext.createBiquadFilter(); filter1.type = "highpass"; filter1.frequency.value = 3500; 
            filter2 = audioContext.createBiquadFilter(); filter2.type = "highpass"; filter2.frequency.value = 3500; 
            
            let bpFilter = audioContext.createBiquadFilter();
            bpFilter.type = "bandpass";
            bpFilter.frequency.value = targetFreq;
            bpFilter.Q.value = 5;

            gainNode = audioContext.createGain(); 
            gainNode.gain.value = 10.0; 

            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(filter1); 
            filter1.connect(filter2); 
            filter2.connect(bpFilter);
            bpFilter.connect(gainNode);
            gainNode.connect(analyser);
            
            analyser.fftSize = 256; 
            isListening = true;
            document.getElementById('btnMic').classList.add('active');
            document.getElementById('micText').innerText = "ASCOLTO ATTIVO";
            detectSound();
        } catch (err) { alert("Errore Microfono: " + err.message); }
    }

    function updateThreshold(val) {
        volumeThreshold = val / 100;
        document.getElementById('threshLine').style.left = val + "%";
    }

    function updateFreq(val) { targetFreq = val; document.getElementById('freqVal').innerText = val + " Hz"; }

    function detectSound() {
        if (!isListening) return;
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
        let average = sum / dataArray.length;
        
        let visualVal = (average / 100) * 100; 
        if (visualVal > 100) visualVal = 100;
        if (visualVal < 5) visualVal = 0; 

        document.getElementById('audioBar').style.width = visualVal + "%";

        if (visualVal > (volumeThreshold * 100) && !cooldown) {
            flashLed();
            triggerAction();
            cooldown = true;
            setTimeout(() => { cooldown = false; }, 600); 
        }
        requestAnimationFrame(detectSound);
    }

    function flashLed() {
        const led = document.getElementById('triggerLed');
        led.classList.add('flash');
        setTimeout(() => led.classList.remove('flash'), 200);
    }

    function triggerAction() { completeCurrent(); }

    // --- GESTIONE FILE ---
    const dropZone = document.getElementById('dropZone');
    // Prevenzione default drag & drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    
    dropZone.addEventListener('dragover', (e) => { dropZone.style.borderColor = 'var(--accent)'; dropZone.style.backgroundColor = '#fff3cd'; });
    dropZone.addEventListener('dragleave', (e) => { dropZone.style.borderColor = '#cbd5e0'; dropZone.style.backgroundColor = '#f8f9fa'; });
    dropZone.addEventListener('drop', (e) => { 
        dropZone.style.borderColor = '#cbd5e0'; dropZone.style.backgroundColor = '#f8f9fa'; 
        handleFiles(e.dataTransfer.files); 
    });
    document.getElementById('fileInput').addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(files) {
        if (!files.length) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            currentFileContent = e.target.result;
            processText(currentFileContent);
        };
        reader.readAsText(files[0]);
        // Update visivo senza cancellare i bottoni
        const p = dropZone.querySelector('p');
        p.innerText = "‚úÖ " + files[0].name;
    }

    function reprocessFile() { if (currentFileContent) processText(currentFileContent); }

    function processText(text) {
        scannedCount = 0;
        updateStats();
        const lines = text.split('\n');
        allData = [];
        
        // REGEX ELASTICA: accetta 6-12 cifre, e caratteri minuscoli/maiuscoli
        const rowRegex = /^([a-zA-Z0-9]{2})\s+(\d{6,12})\s+(\d+)\s+(\d+)\s+([a-zA-Z0-9]{2,4})/;
        const filterType = document.getElementById('filterLogic').value; 

        lines.forEach((line, index) => {
            const cleanLine = line.trim();
            if (!cleanLine || cleanLine.includes('---') || cleanLine.includes('GLS ENTERPRISE') || cleanLine.includes('Sig  N.')) return;

            const match = cleanLine.match(rowRegex);
            if (match) {
                const sigla = match[1].toUpperCase(); 
                let sped = match[2]; 
                const colloRaw = match[3]; 
                const tipo = match[4]; 
                const zona = match[5];
                
                const remainingText = cleanLine.substring(match[0].length);
                
                // Filtri
                if (filterType === "NS" && !/\*\s+N\s+S/.test(remainingText)) return;
                if (filterType === "SN" && !/\*\s+S\s+N/.test(remainingText)) return;
                if (filterType === "NN" && !/\*\s+N\s+N/.test(remainingText)) return;
                if (filterType === "SS" && !/\*\s+S\s+S/.test(remainingText)) return;

                // FIX WW AUTO
                if (sigla === 'WW' && sped.length < 9) {
                    sped = sped.padStart(9, '0');
                }

                const colloFmt = colloRaw.padStart(2, '0');
                const barcodeData = `${sigla}${sped}${colloFmt}${tipo}${zona}`;
                const humanText = `${sigla} ${sped} ${colloFmt} ${tipo} ${zona}`;
                
                let details = cleanLine.substring(match[0].length).trim()
                    .replace(/^[A-Z\s']+\*\s[S]\s[N]\s+/, '')
                    .replace(/^[A-Z\s']+\*\s[N]\s[S]\s+/, '')
                    .replace(/^[A-Z\s']+\*\s[N]\s[N]\s+/, '')
                    .replace(/^[A-Z\s']+\*\s[S]\s[S]\s+/, '');

                const zoneChar = zona.charAt(0).toUpperCase();

                allData.push({
                    id: index, zona: zona, barcodeData: barcodeData, humanText: humanText,
                    details: details, colorClass: `border-${zoneChar}`,
                    fullSearch: (humanText + " " + zona).toLowerCase()
                });
            }
        });
        renderList(allData);
    }

    function renderList(data) {
        const list = document.getElementById('listResult');
        list.innerHTML = '';
        if (data.length === 0) { document.getElementById('emptyState').style.display = 'block'; return; }
        document.getElementById('emptyState').style.display = 'none';
        updateStats(data.length);

        data.forEach(item => {
            const card = document.createElement('div');
            card.className = `barcode-card ${item.colorClass}`;
            card.dataset.id = item.id;
            card.onclick = function() { markAsDone(this); };
            card.innerHTML = `
                <div class="zone-box">
                    <h2>${item.zona}</h2>
                    <span>ZONA</span>
                </div>
                <div class="card-content">
                    <svg id="barcode-${item.id}"></svg>
                    <div class="human-readable">${item.humanText}</div>
                    <div class="details">${item.details}</div>
                </div>`;
            list.appendChild(card);
            try { JsBarcode(`#barcode-${item.id}`, item.barcodeData, { format: "CODE128", width: 1.5, height: 60, displayValue: false, margin: 0 }); } catch (e) {}
        });
        updateFocus();
    }

    function updateFocus() {
        document.querySelectorAll('.active-focus').forEach(el => el.classList.remove('active-focus'));
        const first = document.querySelector('.barcode-card:not(.scanned):not([style*="display: none"])');
        
        if (first) {
            first.classList.add('active-focus');
            const container = document.getElementById('scrollContainer');
            const elementTop = first.offsetTop;
            const elementHeight = first.offsetHeight;
            const containerHeight = container.offsetHeight;
            const targetScroll = elementTop - (containerHeight / 2) + (elementHeight / 2);
            container.scrollTo({ top: targetScroll, behavior: 'smooth' });
        }
    }

    function markAsDone(el) {
        if (el.classList.contains('scanned')) return;
        el.classList.add('scanned');
        scannedCount++;
        updateStats();
        updateFocus();
    }

    function completeCurrent() {
        const curr = document.querySelector('.active-focus');
        if (curr) markAsDone(curr);
    }

    function updateStats(total) {
        if(total !== undefined) document.getElementById('statsTotal').innerText = `Totale: ${total}`;
        document.getElementById('statsDone').innerText = `Fatti: ${scannedCount}`;
    }

    function filterData() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const cards = document.querySelectorAll('.barcode-card');
        cards.forEach(c => {
            const itemData = allData.find(d => d.id == c.dataset.id);
            if(itemData && itemData.fullSearch.includes(q)) c.style.display = 'grid';
            else c.style.display = 'none';
        });
        updateFocus();
    }
    
    document.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'Enter' || e.key === 'ArrowDown') { e.preventDefault(); completeCurrent(); }
    });
</script>

</body>
</html>
